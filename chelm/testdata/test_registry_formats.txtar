# Various container registry formats all detected correctly
chelm test cg.json --chart=chart
cmp stdout expected.json

-- cg.json --
{
  "images": {
    "gcr": {
      "values": {
        "images": {"gcr": "${ref}"}
      }
    },
    "artifact": {
      "values": {
        "images": {"artifact": "${ref}"}
      }
    },
    "ecr": {
      "values": {
        "images": {"ecr": "${ref}"}
      }
    },
    "quay": {
      "values": {
        "images": {"quay": "${ref}"}
      }
    },
    "ghcr": {
      "values": {
        "images": {"ghcr": "${ref}"}
      }
    },
    "dockerhub": {
      "values": {
        "images": {"dockerhub": "${ref}"}
      }
    },
    "withport": {
      "values": {
        "images": {"withport": "${ref}"}
      }
    }
  },
  "test": {
    "cases": [
      {"name": "default", "images": ["gcr", "artifact", "ecr", "quay", "ghcr", "dockerhub", "withport"]}
    ]
  }
}

-- chart/Chart.yaml --
apiVersion: v2
name: test-chart
version: 0.1.0

-- chart/templates/deployment.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test
spec:
  template:
    spec:
      containers:
        - name: gcr
          image: {{ .Values.images.gcr }}
        - name: artifact
          image: {{ .Values.images.artifact }}
        - name: ecr
          image: {{ .Values.images.ecr }}
        - name: quay
          image: {{ .Values.images.quay }}
        - name: ghcr
          image: {{ .Values.images.ghcr }}
        - name: dockerhub
          image: {{ .Values.images.dockerhub }}
        - name: withport
          image: {{ .Values.images.withport }}

-- chart/values.yaml --
images:
  gcr: gcr.io/my-project/myapp:v1.0.0
  artifact: us-docker.pkg.dev/my-project/my-repo/myapp:v1.0.0
  ecr: 123456789012.dkr.ecr.us-east-1.amazonaws.com/myapp:v1.0.0
  quay: quay.io/myorg/myapp:v1.0.0
  ghcr: ghcr.io/myorg/myapp:v1.0.0
  dockerhub: docker.io/library/nginx:1.25
  withport: myregistry.local:5000/myapp:v1.0.0

-- expected.json --
{
  "passed": true,
  "cases": [
    {
      "name": "default",
      "passed": true,
      "images": [
        "cgr.test/chainguard/test/artifact@sha256:c7c5c1d70c5dec4416ab6158afd0b223ef40c29b1dc1f97ed9428b94d4cadb1c",
        "cgr.test/chainguard/test/dockerhub@sha256:c38b90c0390c881262cb57f033ca1039d9e7d904a5a2914ce401e7dc08ab4850",
        "cgr.test/chainguard/test/ecr@sha256:02915c173f5b5238c520514331165c9c1e1d2a5a6d088b612fd675a5f265a853",
        "cgr.test/chainguard/test/gcr@sha256:abe609a59390de52c745bcc8857c6603ba983a8c7ba20122dedb0ed98927e686",
        "cgr.test/chainguard/test/ghcr@sha256:10bc4eece5c5911685770f3c29aac28a7dcc13018f47d7d9715839720966454a",
        "cgr.test/chainguard/test/quay@sha256:33888e30626294cdd4a21da514cfcc1f2694c89482076e065f7eac1c2cf431bd",
        "cgr.test/chainguard/test/withport@sha256:f39d04595a1e33a5ad39a558397b06b765f85af365ad87bf4e1d8477d6233cfb"
      ],
      "expected": [
        "gcr",
        "artifact",
        "ecr",
        "quay",
        "ghcr",
        "dockerhub",
        "withport"
      ],
      "extractors": {
        "regex": [
          "cgr.test/chainguard/test/artifact@sha256:c7c5c1d70c5dec4416ab6158afd0b223ef40c29b1dc1f97ed9428b94d4cadb1c",
          "cgr.test/chainguard/test/dockerhub@sha256:c38b90c0390c881262cb57f033ca1039d9e7d904a5a2914ce401e7dc08ab4850",
          "cgr.test/chainguard/test/ecr@sha256:02915c173f5b5238c520514331165c9c1e1d2a5a6d088b612fd675a5f265a853",
          "cgr.test/chainguard/test/gcr@sha256:abe609a59390de52c745bcc8857c6603ba983a8c7ba20122dedb0ed98927e686",
          "cgr.test/chainguard/test/ghcr@sha256:10bc4eece5c5911685770f3c29aac28a7dcc13018f47d7d9715839720966454a",
          "cgr.test/chainguard/test/quay@sha256:33888e30626294cdd4a21da514cfcc1f2694c89482076e065f7eac1c2cf431bd",
          "cgr.test/chainguard/test/withport@sha256:f39d04595a1e33a5ad39a558397b06b765f85af365ad87bf4e1d8477d6233cfb"
        ],
        "structured": [
          "cgr.test/chainguard/test/artifact@sha256:c7c5c1d70c5dec4416ab6158afd0b223ef40c29b1dc1f97ed9428b94d4cadb1c",
          "cgr.test/chainguard/test/dockerhub@sha256:c38b90c0390c881262cb57f033ca1039d9e7d904a5a2914ce401e7dc08ab4850",
          "cgr.test/chainguard/test/ecr@sha256:02915c173f5b5238c520514331165c9c1e1d2a5a6d088b612fd675a5f265a853",
          "cgr.test/chainguard/test/gcr@sha256:abe609a59390de52c745bcc8857c6603ba983a8c7ba20122dedb0ed98927e686",
          "cgr.test/chainguard/test/ghcr@sha256:10bc4eece5c5911685770f3c29aac28a7dcc13018f47d7d9715839720966454a",
          "cgr.test/chainguard/test/quay@sha256:33888e30626294cdd4a21da514cfcc1f2694c89482076e065f7eac1c2cf431bd",
          "cgr.test/chainguard/test/withport@sha256:f39d04595a1e33a5ad39a558397b06b765f85af365ad87bf4e1d8477d6233cfb"
        ]
      }
    }
  ]
}
