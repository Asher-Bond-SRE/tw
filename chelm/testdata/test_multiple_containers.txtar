# Multiple containers in single pod
chelm test cg.json --chart=chart
cmp stdout expected.json

-- cg.json --
{
  "images": {
    "app": {
      "values": {
        "app": {"image": "${ref}"}
      }
    },
    "sidecar": {
      "values": {
        "sidecar": {"image": "${ref}"}
      }
    },
    "proxy": {
      "values": {
        "proxy": {"image": "${ref}"}
      }
    }
  },
  "test": {
    "cases": [
      {"name": "default", "images": ["app", "sidecar", "proxy"]}
    ]
  }
}

-- chart/Chart.yaml --
apiVersion: v2
name: test-chart
version: 0.1.0

-- chart/templates/deployment.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test
spec:
  template:
    spec:
      containers:
        - name: app
          image: {{ .Values.app.image }}
        - name: sidecar
          image: {{ .Values.sidecar.image }}
        - name: proxy
          image: {{ .Values.proxy.image }}

-- chart/values.yaml --
app:
  image: myapp:v1.0
sidecar:
  image: fluent/fluentd:v1.16
proxy:
  image: envoyproxy/envoy:v1.28

-- expected.json --
{
  "passed": true,
  "cases": [
    {
      "name": "default",
      "passed": true,
      "images": [
        "cgr.test/chainguard/test/app@sha256:a172cedcae47474b615c54d510a5d84a8dea3032e958587430b413538be3f333",
        "cgr.test/chainguard/test/proxy@sha256:1241936d4dd3aad68fe7bfbdfe854b935926bc678fc72377e15166078916227a",
        "cgr.test/chainguard/test/sidecar@sha256:6c8b4535ccc87f19061c4646189e33d78f01c8b63dc4e3cb2f630b1796ee93b6"
      ],
      "expected": [
        "app",
        "sidecar",
        "proxy"
      ],
      "extractors": {
        "regex": [
          "cgr.test/chainguard/test/app@sha256:a172cedcae47474b615c54d510a5d84a8dea3032e958587430b413538be3f333",
          "cgr.test/chainguard/test/proxy@sha256:1241936d4dd3aad68fe7bfbdfe854b935926bc678fc72377e15166078916227a",
          "cgr.test/chainguard/test/sidecar@sha256:6c8b4535ccc87f19061c4646189e33d78f01c8b63dc4e3cb2f630b1796ee93b6"
        ],
        "structured": [
          "cgr.test/chainguard/test/app@sha256:a172cedcae47474b615c54d510a5d84a8dea3032e958587430b413538be3f333",
          "cgr.test/chainguard/test/proxy@sha256:1241936d4dd3aad68fe7bfbdfe854b935926bc678fc72377e15166078916227a",
          "cgr.test/chainguard/test/sidecar@sha256:6c8b4535ccc87f19061c4646189e33d78f01c8b63dc4e3cb2f630b1796ee93b6"
        ]
      }
    }
  ]
}
