# Images via range loop over map
chelm test cg.json --chart=chart
cmp stdout expected.json

-- cg.json --
{
  "images": {
    "worker1": {
      "values": {
        "workers": {"worker1": {"image": "${ref}"}}
      }
    },
    "worker2": {
      "values": {
        "workers": {"worker2": {"image": "${ref}"}}
      }
    }
  },
  "test": {
    "cases": [
      {"name": "default", "images": ["worker1", "worker2"]}
    ]
  }
}

-- chart/Chart.yaml --
apiVersion: v2
name: test-chart
version: 0.1.0

-- chart/templates/deployment.yaml --
apiVersion: apps/v1
kind: Deployment
metadata:
  name: workers
spec:
  template:
    spec:
      containers:
        {{- range $name, $config := .Values.workers }}
        - name: {{ $name }}
          image: {{ $config.image }}
        {{- end }}

-- chart/values.yaml --
workers:
  worker1:
    image: worker:v1
  worker2:
    image: worker:v2

-- expected.json --
{
  "passed": true,
  "cases": [
    {
      "name": "default",
      "passed": true,
      "images": [
        "cgr.test/chainguard/test/worker1@sha256:34aa1081c5b63c28d0343512980e8df6c079c858172b7f5a5272b8e0605b90ad",
        "cgr.test/chainguard/test/worker2@sha256:5257586a4579fd12221c855b9cacf4c5bba169e31d5ebde2acaa8d502e57dcbe"
      ],
      "expected": [
        "worker1",
        "worker2"
      ],
      "extractors": {
        "regex": [
          "cgr.test/chainguard/test/worker1@sha256:34aa1081c5b63c28d0343512980e8df6c079c858172b7f5a5272b8e0605b90ad",
          "cgr.test/chainguard/test/worker2@sha256:5257586a4579fd12221c855b9cacf4c5bba169e31d5ebde2acaa8d502e57dcbe"
        ],
        "structured": [
          "cgr.test/chainguard/test/worker1@sha256:34aa1081c5b63c28d0343512980e8df6c079c858172b7f5a5272b8e0605b90ad",
          "cgr.test/chainguard/test/worker2@sha256:5257586a4579fd12221c855b9cacf4c5bba169e31d5ebde2acaa8d502e57dcbe"
        ]
      }
    }
  ]
}
