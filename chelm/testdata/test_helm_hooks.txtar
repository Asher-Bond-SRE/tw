# Non-test Helm hooks (pre-install, post-upgrade, multiple) are included
chelm test cg.json --chart=chart
cmp stdout expected.json

-- cg.json --
{
  "images": {
    "pre-install": {
      "values": {
        "hooks": {"preInstall": {"image": "${ref}"}}
      }
    },
    "post-upgrade": {
      "values": {
        "hooks": {"postUpgrade": {"image": "${ref}"}}
      }
    },
    "multi-hook": {
      "values": {
        "hooks": {"multiHook": {"image": "${ref}"}}
      }
    }
  },
  "test": {
    "cases": [
      {"name": "default", "images": ["pre-install", "post-upgrade", "multi-hook"]}
    ]
  }
}

-- chart/Chart.yaml --
apiVersion: v2
name: test-chart
version: 0.1.0

-- chart/templates/pre-install.yaml --
apiVersion: batch/v1
kind: Job
metadata:
  name: pre-install-job
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: migrate
          image: {{ .Values.hooks.preInstall.image }}

-- chart/templates/post-upgrade.yaml --
apiVersion: batch/v1
kind: Job
metadata:
  name: post-upgrade-job
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-weight": "0"
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: migrate
          image: {{ .Values.hooks.postUpgrade.image }}

-- chart/templates/multi-hook.yaml --
apiVersion: batch/v1
kind: Job
metadata:
  name: multi-hook-job
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: setup
          image: {{ .Values.hooks.multiHook.image }}

-- chart/values.yaml --
hooks:
  preInstall:
    image: flyway/flyway:10
  postUpgrade:
    image: liquibase/liquibase:4.25
  multiHook:
    image: busybox:1.36

-- expected.json --
{
  "passed": true,
  "cases": [
    {
      "name": "default",
      "passed": true,
      "images": [
        "cgr.test/chainguard/test/multi-hook@sha256:d48bf38da8fcbad3b32c443bf2ee26571c066d889e3d9728304e0074e04afb67",
        "cgr.test/chainguard/test/post-upgrade@sha256:9af7430d8ba77fd71decddb28a4d3f5099d8ae9479057d41db13a51a9dc463f0",
        "cgr.test/chainguard/test/pre-install@sha256:43700cae8fc9a0b05431663b690bffb835935711644fd4a3cfc1b610060e0acf"
      ],
      "expected": [
        "pre-install",
        "post-upgrade",
        "multi-hook"
      ],
      "extractors": {
        "regex": [
          "cgr.test/chainguard/test/multi-hook@sha256:d48bf38da8fcbad3b32c443bf2ee26571c066d889e3d9728304e0074e04afb67",
          "cgr.test/chainguard/test/post-upgrade@sha256:9af7430d8ba77fd71decddb28a4d3f5099d8ae9479057d41db13a51a9dc463f0",
          "cgr.test/chainguard/test/pre-install@sha256:43700cae8fc9a0b05431663b690bffb835935711644fd4a3cfc1b610060e0acf"
        ],
        "structured": [
          "cgr.test/chainguard/test/multi-hook@sha256:d48bf38da8fcbad3b32c443bf2ee26571c066d889e3d9728304e0074e04afb67",
          "cgr.test/chainguard/test/post-upgrade@sha256:9af7430d8ba77fd71decddb28a4d3f5099d8ae9479057d41db13a51a9dc463f0",
          "cgr.test/chainguard/test/pre-install@sha256:43700cae8fc9a0b05431663b690bffb835935711644fd4a3cfc1b610060e0acf"
        ]
      }
    }
  ]
}
